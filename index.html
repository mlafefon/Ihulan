
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>יוצר שערי מגזין</title>
    <!-- Google Fonts will be loaded dynamically by js/fonts.js -->
    <link rel="stylesheet" href="index.css">
</head>
<body class="bg-slate-900 text-white">
    <div class="min-h-screen bg-slate-900 flex flex-col lg:flex-row items-start justify-center p-4 lg:p-8 gap-8">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-full lg:w-96 bg-slate-800 p-6 rounded-lg shadow-lg flex flex-col self-start">
            <div class="mb-6">
                <h1 class="text-3xl font-bold text-white">יוצר שערי מגזין</h1>
                <p class="text-slate-400 mt-2">
                    עצבו את שער המגזין שלכם. לחצו על אלמנט כדי לבחור אותו, ולחצו שוב על טקסט כדי לערוך אותו ישירות.
                </p>
            </div>
            
            <div id="sidebar-editor-header" class="hidden flex-shrink-0">
                <!-- Dynamic fixed header will be injected here -->
            </div>

            <div id="sidebar-content" class="hidden flex-grow overflow-y-auto pr-2 space-y-4 min-h-[200px]">
                <!-- Dynamic content for editor mode will be injected here -->
            </div>

            <div id="template-actions" class="mb-6">
                 <div class="py-4 border-t border-b border-slate-700 space-y-4">
                    <div>
                        <label for="template-name-input" class="block text-sm font-medium text-slate-300 mb-1">שם התבנית</label>
                        <input type="text" id="template-name-input" class="w-full bg-slate-700 border border-slate-600 text-white rounded-md p-2" placeholder="הכנס שם לתבנית...">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-300 mb-1">מידות (בפיקסלים)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="template-width-input" class="w-full bg-slate-700 border border-slate-600 text-white rounded-md p-2 text-center" placeholder="רוחב" title="רוחב">
                            <span class="text-slate-400 text-lg font-bold">x</span>
                            <input type="number" id="template-height-input" class="w-full bg-slate-700 border border-slate-600 text-white rounded-md p-2 text-center" placeholder="גובה" title="גובה">
                        </div>
                    </div>
                </div>

                <div class="py-4 border-b border-slate-700">
                     <p class="text-slate-400 mb-4">בחר אלמנט מהשער כדי לערוך אותו, או הוסף אלמנט חדש.</p>
                     <div class="space-y-3">
                        <div class="flex gap-3">
                            <button data-action="add-element" data-type="text" class="sidebar-btn bg-sky-600 hover:bg-sky-700 flex-1 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 24 24" fill="currentColor"><path d="M5 4h14a1 1 0 010 2h-6v13a1 1 0 01-2 0V6H5a1 1 0 110-2z"/></svg>
                                <span>הוסף טקסט</span>
                            </button>
                            <button data-action="add-element" data-type="image" class="sidebar-btn bg-sky-600 hover:bg-sky-700 flex-1 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                <span>הוסף תמונה</span>
                            </button>
                        </div>
                        <button data-action="add-element" data-type="clipping-shape" class="sidebar-btn bg-fuchsia-600 hover:bg-fuchsia-700">הוסף צורת חיתוך</button>
                    </div>
                </div>

                <div class="pt-4 space-y-3">
                     <button id="change-template-btn" class="sidebar-btn bg-blue-600 hover:bg-blue-700">
                        בחר תבנית
                    </button>
                </div>
            </div>
            
            <div id="history-actions" class="mt-auto mt-4 py-4 flex justify-center gap-8">
                <button id="undo-btn" class="sidebar-btn-icon bg-slate-600 hover:bg-slate-500" title="בטל (Ctrl+Z)" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 15l-3-3m0 0l3-3m-3 3h8a5 5 0 010 10H6"></path>
                    </svg>
                </button>
                <button id="redo-btn" class="sidebar-btn-icon bg-slate-600 hover:bg-slate-500" title="בצע שוב (Ctrl+Y)" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 15l3-3m0 0l-3-3m3 3H8a5 5 0 000 10h1"></path>
                    </svg>
                </button>
            </div>

            <div id="bottom-actions" class="pt-4">
                 <div class="grid grid-cols-2 gap-3">
                    <button id="save-template-btn" class="sidebar-btn bg-green-600 hover:bg-green-700">
                        שמור שינויים
                    </button>
                    <button id="export-image-btn" class="sidebar-btn bg-fuchsia-600 hover:bg-fuchsia-700">
                        שמור כתמונה
                    </button>
                    <button id="import-template-btn" class="sidebar-btn bg-slate-600 hover:bg-slate-500">
                        טען תבנית
                    </button>
                    <button id="export-template-btn" class="sidebar-btn bg-slate-600 hover:bg-slate-500">
                        שמור כקובץ
                    </button>
                </div>
            </div>

             <input id="element-image-upload" type="file" accept="image/*" class="hidden" />
             <input id="import-template-input" type="file" accept=".json" class="hidden" />

        </aside>

        <!-- Magazine Cover -->
        <main class="flex-1 flex items-center justify-center w-full">
            <div id="magazine-cover" class="w-full max-w-[700px] shadow-2xl mx-auto">
                <div id="cover-boundary" class="relative w-full h-full overflow-hidden bg-slate-700">
                    <!-- Cover content will be dynamically generated here -->
                </div>
            </div>
        </main>
    </div>
    
    <!-- Template Selection Modal -->
    <div id="template-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="template-modal-title">
        <div id="template-modal-overlay" class="absolute inset-0"></div>
        <div class="bg-slate-800 rounded-lg shadow-xl p-6 w-full max-w-4xl max-h-[90vh] flex flex-col relative">
            <div class="flex justify-between items-center mb-4">
                <h2 id="template-modal-title" class="text-2xl font-bold text-white">בחר תבנית עיצוב</h2>
                <button id="modal-close-btn" class="modal-close-btn-style" aria-label="Close modal">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="template-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto p-2">
                <!-- Template previews will be injected here -->
            </div>
        </div>
    </div>

    <!-- Image Editor Modal -->
    <div id="image-editor-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="image-editor-title">
        <div class="bg-slate-900 rounded-lg shadow-xl p-4 lg:p-8 w-full max-w-7xl h-[95vh] max-h-[95vh] flex flex-col relative">
            <div class="flex justify-between items-center mb-4">
                <h2 id="image-editor-title" class="text-2xl font-bold text-white">עריכת תמונה</h2>
                <button id="image-editor-close-btn" class="modal-close-btn-style" aria-label="Close modal">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex-grow flex flex-col lg:flex-row gap-8 min-h-0">
                <!-- Image Editor Sidebar -->
                <aside id="image-editor-sidebar" class="w-full lg:w-96 bg-slate-800 p-6 rounded-lg shadow-lg flex flex-col overflow-y-auto">
                    <div>
                        <h3 class="text-lg font-semibold text-slate-300">מידע</h3>
                        <p class="text-sm text-slate-400">רזולוציית מקור: <span id="source-res"></span></p>
                        <p class="text-sm text-slate-400">רזולוציית יעד: <span id="target-res"></span></p>
                    </div>
                    <div class="mt-4 flex items-center gap-3">
                        <label for="zoom-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap">זום</label>
                        <input id="zoom-slider" type="range" min="1" max="3" step="0.01" value="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                    
                    <div id="image-editor-accordion-container" class="mt-4 pt-4 border-t border-slate-700 space-y-1 flex-grow">
                      <div class="accordion-group">
                        <button type="button" class="accordion-toggle" aria-expanded="false" aria-controls="filter-panel">
                          <span>פילטרים</span>
                          <svg class="accordion-chevron h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="filter-panel" class="accordion-panel space-y-2">
                           <div class="flex items-center gap-3">
                               <label for="brightness-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap w-24 flex-shrink-0">בהירות</label>
                               <input id="brightness-slider" data-filter="brightness" type="range" min="0" max="200" value="100" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                           </div>
                           <div class="flex items-center gap-3">
                               <label for="contrast-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap w-24 flex-shrink-0">ניגודיות</label>
                               <input id="contrast-slider" data-filter="contrast" type="range" min="0" max="200" value="100" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                           </div>
                           <div class="flex items-center gap-3">
                               <label for="saturation-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap w-24 flex-shrink-0">רוויה</label>
                               <input id="saturation-slider" data-filter="saturation" type="range" min="0" max="200" value="100" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                           </div>
                           <div class="flex items-center gap-3">
                               <label for="grayscale-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap w-24 flex-shrink-0">גווני אפור</label>
                               <input id="grayscale-slider" data-filter="grayscale" type="range" min="0" max="100" value="0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                           </div>
                           <div class="flex items-center gap-3">
                               <label for="sepia-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap w-24 flex-shrink-0">ספיה</label>
                               <input id="sepia-slider" data-filter="sepia" type="range" min="0" max="100" value="0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                           </div>
                           <button id="reset-filters-btn" class="w-full mt-3 bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors">איפוס פילטרים</button>
                        </div>
                      </div>

                      <div class="accordion-group pt-2 border-t border-slate-700">
                        <button type="button" class="accordion-toggle" aria-expanded="false" aria-controls="colorswap-panel">
                          <span>החלפת צבע</span>
                           <svg class="accordion-chevron h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="colorswap-panel" class="accordion-panel space-y-3">
                           <p class="text-sm text-slate-400">לחץ על כפתור בחירת הצבע, ואז לחץ על צבעים בתמונה כדי להוסיף אותם להחלפה.</p>
                           <div class="flex items-start gap-3">
                               <div class="color-swap-box flex-1">
                                   <span class="color-swap-label">צבעי מקור (לחץ להסרה)</span>
                                    <div class="flex items-center gap-2 mt-1">
                                       <button id="pick-color-btn" class="color-swatch-btn flex-shrink-0" title="הוסף צבע מקור">
                                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400" viewBox="0 0 24 24" fill="currentColor">
                                               <path d="M13.52 5.08C12.42 4.02 10.76 4 9.62 5.08L3.08 11.24C2.39 11.89 2 12.83 2 13.79V19C2 20.1 2.9 21 4 21H9.21C10.17 21 11.11 20.61 11.76 19.92L18.3 13.76C19.36 12.7 19.4 11.04 18.3 10L13.52 5.08Z"></path><path d="M22 5.15L18.85 2C18.66 1.83 18.42 1.72 18.17 1.71C17.65 1.68 17.15 1.88 16.78 2.22L15 3.87L19.5 8.37L21.78 6.09C22.12 5.72 22.32 5.22 22.29 4.7C22.28 4.45 22.17 4.21 22 4.02V4.02C22 4.02 22 5.15 22 5.15Z"></path>
                                           </svg>
                                       </button>
                                       <div id="source-colors-container" class="source-colors-container">
                                           <!-- Injected by JS -->
                                       </div>
                                    </div>
                               </div>
                               <div class="text-slate-500 text-xl font-light self-end pb-2">&larr;</div>
                               <div class="color-swap-box">
                                   <span class="color-swap-label">יעד</span>
                                   <label for="target-color-picker" class="color-swatch-btn" title="בחר צבע יעד">
                                        <div id="target-color-swatch" style="background-color: #ff0000;"></div>
                                   </label>
                                   <input type="color" id="target-color-picker" value="#ff0000" class="native-color-picker">
                               </div>
                           </div>
                           <div class="flex items-center gap-3">
                               <label for="color-tolerance-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap w-28 flex-shrink-0">רגישות: <span id="tolerance-value">20</span></label>
                               <input id="color-tolerance-slider" type="range" min="0" max="150" value="20" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                           </div>
                            <button id="reset-color-swap-btn" class="w-full mt-2 bg-slate-600 hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg text-sm transition-colors">איפוס החלפת צבע</button>
                        </div>
                      </div>

                      <div class="accordion-group pt-2 border-t border-slate-700">
                        <button type="button" class="accordion-toggle" aria-expanded="false" aria-controls="blur-panel">
                          <span>טשטוש</span>
                          <svg class="accordion-chevron h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="blur-panel" class="accordion-panel space-y-4">
                           <p class="text-sm text-slate-400">סמן את האזור שיישאר חד. כל השאר יטושטש.</p>
                           <div class="flex items-center gap-3">
                               <label for="brush-size-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap w-28 flex-shrink-0">גודל מברשת: <span id="brush-size-value">20</span></label>
                               <input id="brush-size-slider" type="range" min="5" max="50" value="20" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                           </div>
                           <div class="flex gap-2">
                                <button id="mark-sharp-area-btn" class="sidebar-btn-icon bg-slate-600 hover:bg-slate-500" title="מברשת סימון">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <rect x="8" y="4" width="12" height="6" rx="1"></rect>
                                      <path d="M8 7a3 3 0 00-3 3v2M14 11v6a2 2 0 01-2 2h0a2 2 0 01-2-2v-6"></path>
                                      <!-- Plus, solid -->
                                      <g fill="currentColor" stroke="none">
                                        <path d="M4 17h2v2H4v2H2v-2H0v-2h2v-2h2v2z"/>
                                      </g>
                                    </svg>
                                </button>
                                <button id="erase-sharp-area-btn" class="sidebar-btn-icon bg-slate-600 hover:bg-slate-500" title="מחק מברשת סימון">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                      <rect x="8" y="4" width="12" height="6" rx="1"></rect>
                                      <path d="M8 7a3 3 0 00-3 3v2M14 11v6a2 2 0 01-2 2h0a2 2 0 01-2-2v-6"></path>
                                      <!-- Minus, solid -->
                                      <g fill="currentColor" stroke="none">
                                        <rect x="0" y="18" width="8" height="2" rx="1"/>
                                      </g>
                                    </svg>
                                </button>
                                <button id="apply-blur-btn" class="sidebar-btn-icon bg-slate-600 hover:bg-slate-500" title="בצע טשטוש">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                                    </svg>
                                </button>
                                <button id="reset-blur-btn" class="sidebar-btn-icon bg-slate-600 hover:bg-slate-500" title="איפוס טשטוש">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                           </div>
                        </div>
                      </div>
                      
                      <div class="accordion-group pt-2 border-t border-slate-700">
                        <button type="button" class="accordion-toggle" aria-expanded="false" aria-controls="frame-panel">
                          <span>מסגרת</span>
                          <svg class="accordion-chevron h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div id="frame-panel" class="accordion-panel space-y-4">
                           <div class="flex items-center gap-3">
                               <label for="frame-width-slider" class="text-sm font-medium text-slate-300 whitespace-nowrap w-28 flex-shrink-0">עובי: <span id="frame-width-value">0</span>px</label>
                               <input id="frame-width-slider" type="range" min="0" max="50" value="0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                           </div>
                           <div class="flex items-center gap-3">
                               <label for="frame-style-select" class="text-sm font-medium text-slate-300 whitespace-nowrap w-28 flex-shrink-0">סגנון</label>
                               <select id="frame-style-select" class="w-full bg-slate-700 border border-slate-600 text-white rounded-md p-2 h-10">
                                   <option value="none">ללא מסגרת</option>
                                   <option value="solid">מלא</option>
                                   <option value="dashed">מקווקו</option>
                                   <option value="dotted">מנוקד</option>
                                   <option value="double">כפול</option>
                               </select>
                           </div>
                           <div class="flex items-center gap-3">
                               <label for="frame-color-picker" class="text-sm font-medium text-slate-300 whitespace-nowrap w-28 flex-shrink-0">צבע</label>
                               <input type="color" id="frame-color-picker" value="#000000" class="w-full h-10 p-1 bg-slate-700 border border-slate-600 rounded-md cursor-pointer">
                           </div>
                        </div>
                      </div>

                    </div>
                    <div class="flex-shrink-0 flex gap-3 pt-4 border-t border-slate-700 mt-auto">
                        <button id="replace-image-btn" class="sidebar-btn bg-sky-600 hover:bg-sky-700 flex-1">החלף תמונה</button>
                        <button id="confirm-crop-btn" class="sidebar-btn bg-green-600 hover:bg-green-700 flex-1">אישור וחיתוך</button>
                    </div>
                </aside>

                <!-- Preview Area -->
                <main class="flex-1 flex items-center justify-center min-w-0">
                    <div id="image-preview-container" class="w-full h-full flex items-center justify-center bg-slate-900 rounded-md relative overflow-hidden">
                        <!-- This wrapper handles drag events and contains the image -->
                        <div id="image-preview-wrapper" class="absolute top-0 left-0 w-full h-full cursor-move">
                            <img id="image-preview-img" class="absolute top-0 left-0 pointer-events-none" style="transform-origin: 0 0;">
                        </div>
                        <!-- This canvas is for drawing the blur mask -->
                        <canvas id="blur-canvas" class="absolute pointer-events-none"></canvas>
                        <!-- This frame serves as the visual crop guide and mask overlay -->
                        <div id="image-preview-frame" class="absolute pointer-events-none"></div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script type="module" src="index.js"></script>
</body>
</html>
